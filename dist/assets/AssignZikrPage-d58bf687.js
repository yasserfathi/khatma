import{au as O,p as Z,a2 as E,c as F,w as l,k as r,l as c,o as p,g as o,a as s,j as g,a7 as b,a8 as V,a6 as S,av as G,d as I,a5 as H,f as N,h as J,Q as P,a1 as K}from"./index-fb423868.js";import{S as w,a as W,Q as X}from"./sweetalert2.esm.all-a61fabd4.js";import{Q as Y}from"./QForm-ac163a32.js";import{Q as ee,a as ae}from"./QTable-5a681be7.js";import{Q as te}from"./QPage-c4af3978.js";import{_ as se}from"./_plugin-vue_export-helper-c27b6911.js";import"./format-1ba3b2e1.js";import"./position-engine-c8cf3575.js";import"./QLinearProgress-9302dcdc.js";const le={class:"row items-center q-mb-lg"},re={class:"q-ml-md"},oe={key:0,class:"text-subtitle2 text-grey-7"},ie={key:0,class:"row justify-center q-py-xl"},ne={key:1,class:"row q-col-gutter-lg"},ue={class:"col-12 col-md-5"},de={key:0,class:"row justify-center q-mb-sm"},ce={class:"text-weight-bold q-ml-xs"},me={class:"col-12 col-md-7"},pe={class:"row justify-center q-gutter-x-sm"},ve={__name:"AssignZikrPage",setup(fe){const x=O().params.id,h=r(!0),C=r(!1),m=r(null),v=r([]),$=r([]),k=r([]),u=r(null),f=r(0),d=r(null),Q=r({}),B=Z(()=>u.value?v.value.find(e=>e.id===u.value):null),R=[{name:"participant_no",label:"الكود",field:e=>Q.value[e.user_id]||"---",align:"center",sortable:!0},{name:"user",label:"الاسم",field:e=>{var a;return((a=e.user)==null?void 0:a.name)||""},align:"left",sortable:!0},{name:"zikr_count",label:"العدد",field:"zikr_count",align:"center",sortable:!0},{name:"actions",label:"الإجراءات",align:"center"}],q=async()=>{h.value=!0;try{const[e,a,n]=await Promise.all([c.get(`/api/khatmas/${x}`),c.get("/api/users"),c.get("/api/zikr-khatma-assignments",{params:{khatma_id:x}})]);m.value=e.data;const t=await c.get("/api/zikr-group-participants",{params:{group_id:m.value.group_id}}),y={};t.data.forEach(i=>{y[i.user_id]=i.participant_no}),Q.value=y,v.value=a.data.filter(i=>{var A;const _=String(m.value.group_id);return(A=i.group_numbers)==null?void 0:A.some(M=>String(M)===_)}).map(i=>{const _=String(Q.value[i.id]||"");return{...i,participant_no:_,label:_?`${_} - ${i.name}`:i.name}}),k.value=v.value,$.value=n.data}catch{w.fire({icon:"error",title:"خطأ",text:"فشل تحميل البيانات"})}finally{h.value=!1}},U=(e,a)=>{if(e===""){a(()=>{k.value=v.value});return}a(()=>{const n=e.toLowerCase();k.value=v.value.filter(t=>t.name.toLowerCase().indexOf(n)>-1||t.participant_no.toLowerCase().indexOf(n)>-1)})},j=async()=>{C.value=!0;try{const e={khatma_id:x,user_id:u.value,zikr_count:f.value};d.value?await c.put(`/api/zikr-khatma-assignments/${d.value}`,e):await c.post("/api/zikr-khatma-assignments",e),z(),q()}catch{w.fire({icon:"error",title:"خطأ",text:"فشل الحفظ"})}finally{C.value=!1}},D=e=>{d.value=e.id,u.value=e.user_id,f.value=e.zikr_count},L=e=>{w.fire({title:"تأكيد الحذف",icon:"warning",showCancelButton:!0,confirmButtonText:"نعم",cancelButtonText:"إلغاء"}).then(async a=>{if(a.isConfirmed)try{await c.delete(`/api/zikr-khatma-assignments/${e.id}`),q(),d.value===e.id&&z()}catch{w.fire("خطأ","فشل الحذف","error")}})},T=r(null),z=()=>{u.value=null,f.value=0,d.value=null,K(()=>{var e;return(e=T.value)==null?void 0:e.resetValidation()})};return E(q),(e,a)=>(p(),F(te,{class:"q-pa-md"},{default:l(()=>{var n;return[o("div",le,[s(g,{flat:"",round:"",color:"primary",icon:"arrow_forward",onClick:a[0]||(a[0]=t=>e.$router.push("/khatma-zikr"))}),o("div",re,[a[3]||(a[3]=o("div",{class:"text-h5 text-primary text-weight-bold"},"ختمة ذكر الرسول صلى الله عليه وسلم",-1)),m.value?(p(),b("div",oe,V(m.value.khatma_no||"الختمة")+" - "+V((n=m.value.group)==null?void 0:n.name),1)):S("",!0)])]),h.value?(p(),b("div",ie,[s(G,{color:"primary",size:"3em"})])):(p(),b("div",ne,[o("div",ue,[s(P,{class:"glass-card q-pa-md"},{default:l(()=>[s(I,null,{default:l(()=>[a[5]||(a[5]=o("div",{class:"text-h6 text-primary q-mb-md"},"ادخال جديد",-1)),s(Y,{ref_key:"assignForm",ref:T,onSubmit:j,class:"q-gutter-md"},{default:l(()=>[B.value?(p(),b("div",de,[s(W,{outline:"",color:"primary","text-color":"primary",icon:"tag",class:"shadow-1"},{default:l(()=>[a[4]||(a[4]=H(" رقم المشارك: ",-1)),o("span",ce,V(B.value.participant_no||"غير محدد"),1)]),_:1})])):S("",!0),s(X,{filled:"",modelValue:u.value,"onUpdate:modelValue":a[1]||(a[1]=t=>u.value=t),options:k.value,"option-value":"id","option-label":"label",label:"اختر الشخص",color:"primary","emit-value":"","map-options":"","use-input":"",onFilter:U,rules:[t=>!!t||"يرجى اختيار الشخص"]},{prepend:l(()=>[s(N,{name:"person",color:"primary"})]),_:1},8,["modelValue","options","rules"]),s(J,{filled:"",modelValue:f.value,"onUpdate:modelValue":a[2]||(a[2]=t=>f.value=t),modelModifiers:{number:!0},label:"عدد ذكر الرسول صلى الله عليه وسلم",type:"number",color:"primary",rules:[t=>t>=0||"يجب أن يكون 0 أو أكثر"]},{prepend:l(()=>[s(N,{name:"pin",color:"primary"})]),_:1},8,["modelValue","rules"]),s(g,{label:d.value?"تحديث":"حفظ",type:"submit",color:"primary",class:"full-width q-mt-md",unelevated:"",loading:C.value},null,8,["label","loading"]),d.value?(p(),F(g,{key:1,label:"إلغاء التعديل",flat:"",color:"grey",class:"full-width q-mt-sm",onClick:z})):S("",!0)]),_:1},512)]),_:1})]),_:1})]),o("div",me,[s(P,{class:"glass-card q-pa-sm"},{default:l(()=>[s(I,null,{default:l(()=>[a[7]||(a[7]=o("div",{class:"text-h6 text-primary q-mb-md"},"تفاصيل الختمة",-1)),s(ee,{rows:$.value,columns:R,"row-key":"id",flat:"",separator:"none",class:"bg-transparent custom-table"},{"body-cell-actions":l(t=>[s(ae,{props:t,"auto-width":""},{default:l(()=>[o("div",pe,[s(g,{flat:"",round:"",color:"primary",icon:"edit",size:"sm",onClick:y=>D(t.row)},null,8,["onClick"]),s(g,{flat:"",round:"",color:"red",icon:"delete",size:"sm",onClick:y=>L(t.row)},null,8,["onClick"])])]),_:2},1032,["props"])]),"no-data":l(()=>[...a[6]||(a[6]=[o("div",{class:"full-width row flex-center text-grey-6 q-pa-lg"}," لا توجد توزيعات بعد ",-1)])]),_:1},8,["rows"])]),_:1})]),_:1})])]))]}),_:1}))}},qe=se(ve,[["__scopeId","data-v-ca1debbd"]]);export{qe as default};
